{% extends "layout.html" %}

{% block title %}{{ level.name }} Görev Detayı{% endblock %}

{% block content %}

<header class="page-header">
    <a href="{{ url_for('menu') }}" class="back-arrow"><i class="fas fa-chevron-left"></i></a>
    <h1>{{ level.name }}</h1>
</header>

<main>
    <!-- Üstteki turuncu bakiye alanı -->
    <section class="task-header">
        <h2>Account Balance:</h2>
        <p class="balance" id="balance-display">{{ "%.2f"|format(user.balance) }} USDT</p>
    </section>
    
    <!-- İstatistik kartı -->
    <div class="task-stats-box">
        <div class="stat-item">
            <!-- Bugünkü komisyon backend’den gelen değerle -->
            <div class="stat-value" id="commission-today">{{ "%.2f"|format(today_commission) }} USDT</div>
            <div class="stat-label">Today's commission</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="times-today">{{ tasks_done }} / {{ level.max_tasks }}</div>
            <div class="stat-label">Tasks Completed</div>
        </div>
    </div>
    
    <form id="grab-order-form" style="text-align: center;">
        <input type="hidden" name="level_id" value="{{ level.level }}">
        <button type="submit" class="btn-primary grab-order-button">Grab the order immediately</button>
    </form>
    
    <div class="hints content">
        <h3>Hint:</h3>
        <p>1: {{ level.commission_rate }}% of the amount of completed transactions earned.</p>
        <p>2: The system sends tasks randomly. Complete them as soon as possible after matching them, so as to avoid hanging all the time.</p>
    </div>
</main>

<script>
    document.getElementById('grab-order-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const levelId = form.querySelector('input[name=level_id]').value;
        const button = form.querySelector('button');
        
        button.disabled = true;
        button.textContent = 'Processing...';

        fetch("{{ url_for('grab_order') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'level_id=' + levelId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Bakiye güncelle
                document.getElementById('balance-display').textContent = data.new_balance + ' USDT';
                
                // Bugünkü komisyon güncelle
                const commissionTodayEl = document.getElementById('commission-today');
                let currentCommission = parseFloat(commissionTodayEl.textContent) || 0;
                if (data.commission_earned) {
                    currentCommission += parseFloat(data.commission_earned);
                }
                commissionTodayEl.textContent = currentCommission.toFixed(2) + ' USDT';

                // Görev sayısını güncelle
                document.getElementById('times-today').textContent = data.tasks_completed + ' / {{ level.max_tasks }}';

                alert(data.message);
            } else {
                alert('Hata: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bir sunucu hatası oluştu. Lütfen tekrar deneyin.');
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = 'Grab the order immediately';
        });
    });
</script>
{% endblock %}
